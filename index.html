<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WORKSPHERE - Updated</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
   * { 
     margin: 0; 
     padding: 0; 
     box-sizing: 
     border-box;
     font-family: "Segoe UI", sans-serif; 
   }

    body {
      display: flex;
      min-height: 100vh;
      background: linear-gradient(135deg, #3c1053 0%, #ad5389 60%);
      color: #333;
    }

    .sidebar {
      width: 250px;
      background: rgba(20, 6, 30, 0.95);
      backdrop-filter: blur(8px);
      padding: 22px 18px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(255, 255, 255, 0.06);
      color: #fff;
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 24px;
      font-size: 20px;
      font-weight: 700;
      color: #ffd6f0;
    }

    .sidebar a {
      padding: 12px 14px;
      color: #ddd;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
      border-radius: 10px;
      transition: all 0.18s ease;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: linear-gradient(90deg, rgba(122,28,162,0.12), rgba(255,102,178,0.12));
      color: #fff;
      transform: translateX(6px);
    }

   
    .main {
      flex: 1;
      padding: 22px 28px;
      overflow-y: auto;
      background-color: #fafafa;
      border-radius: 0 18px 18px 0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }

    .title-left {
      display:flex;
      align-items:center;
      gap:12px; 
    }

    .header h1 {
      font-size: 22px;
      font-weight: 800;
      color: #4b1262;
      letter-spacing: 0.3px;
    }

    .user-badge {
      display:flex; align-items:center; 
      gap:10px; 
      background:#fff; 
      padding:8px 12px; 
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.04);
    }

    .user-initial {
      width:36px; 
      height:36px; 
      border-radius:50%; 
      background:#6a0dad; 
      color:#fff; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      font-weight:700;
    }

    .header input {
      padding: 9px 14px;
      border: 1px solid #e6e6e6;
      border-radius: 999px;
      outline: none;
      width: 260px;
      font-size: 14px;
      background: #fff;
      box-shadow: 0 4px 14px rgba(106,13,173,0.06);
    }


    .cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      margin-bottom: 16px;
    }

    .card {
      background: #fff;
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      transition: transform 0.18s ease;
    }

    .card:hover { 
      transform: translateY(-6px); 
    }

    .card h3 { 
      margin-bottom:10px; 
      font-size:16px; 
      color:#6a0dad; 
      display:flex; 
      align-items:center; 
      gap:8px; }

    #dashboard-upcoming {
      background: #fff8fc;
      border: 2px solid #ff9ad4;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 6px 20px rgba(255, 102, 178, 0.15);
      animation: glow 1.8s ease-in-out infinite alternate;
    }

    #dashboard-upcoming h4 {
      background: linear-gradient(90deg,#ff66b2,#ffb6f2);
      color: white;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 800;
      margin-bottom: 10px;
      text-align: center;
      letter-spacing: 0.5px;
    }

    #dashboard-upcoming li {
      list-style: none;
      margin-bottom: 8px;
      padding: 10px 12px;
      background: #fff;
      border-radius: 10px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    #dashboard-upcoming li::before {
      content: "âœ…";
      font-size: 1rem;
    }
    #activity-feed, #bulletin-board {
      max-height: 260px;
      overflow-y: auto;
      padding: 12px;
      background: #fbfbfd;
      border: 1px solid #f0eef6;
      border-radius: 12px;
    }

    .feed-item { 
      background: #fff; 
      margin-bottom: 10px; 
      padding: 10px; 
      border-radius:10px; 
      font-size:0.92rem; 
      box-shadow:0 1px 4px rgba(0,0,0,0.03); 
    }

    .feed-time { 
      font-size: 0.75rem; 
      color: #777; 
      margin-top:6px;
    }

  
    .collab-wrap {
      display:flex;
      gap:18px; 
    }

    .collab-table {
      width: 100%; 
      border-collapse: collapse; 
      background:#fff; 
      border-radius:12px; 
      overflow:hidden; 
      box-shadow:0 6px 18px rgba(0,0,0,0.04);
    }

    .collab-table th, .collab-table td { 
      padding:12px 14px; 
      border-bottom:1px solid #f1eef6; 
      text-align:left; 
      vertical-align:middle; 
    }
    
    .collab-table th { 
      background:#faf5ff; 
      color:#5b3b7a; 
      font-weight:700; 
    }

    .task-title { 
      font-weight:700; 
      color:#4a1260; 
    }

    .profile-stack { 
      display:flex; gap:6px; 
      align-items:center; 
    }

    .profile-circle { 
      width:34px; 
      height:34px; 
      border-radius:50%; 
      background:#ddd; 
      color:#fff; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      font-weight:700; 
      font-size:13px; 
      text-transform:uppercase; 
      box-shadow:0 2px 6px rgba(0,0,0,0.06); 
    }

    .btn-join, .btn-done {
      background: linear-gradient(90deg,#6a0dad,#ff66b2);
      color: white; 
      border:none; 
      padding:8px 12px; 
      border-radius:8px; 
      cursor:pointer; 
      font-weight:700; 
      box-shadow:0 6px 14px rgba(106,13,173,0.08);
    }

    .btn-join.small { 
      padding:6px 10px; 
      font-size:13px; 
    }

    .btn-done { 
      background: linear-gradient(90deg,#1fa35a,#3ccf7f); 
    }

    .btn-ghost { 
      background:transparent; 
      border:1px solid #eee; 
      padding:6px 8px; 
      border-radius:8px; 
      cursor:pointer; 
    }

    .done-tag { 
      background:#eafaf0; 
      color:#1a8a4a; 
      padding:6px 8px; 
      border-radius:8px; 
      font-weight:700; 
    }


    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0;
      background: #fff;
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.04);
    }

    .calendar-header button {
      background: linear-gradient(90deg,#fff 0%, #fff 100%);
      color: #6a0dad;
      border: 1px solid rgba(106,13,173,0.12);
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      display:flex; align-items:center; gap:8px; font-weight:700;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .calendar-header button:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 8px 20px rgba(106,13,173,0.08); 
    }

    .calendar-grid { 
      display:grid; 
      grid-template-columns: repeat(7, 1fr); 
      gap:8px; 
      margin-bottom:12px; 
    }

    .day { 
      padding:12px; 
      text-align:center; 
      border-radius:8px;
      cursor:pointer; 
      transition: background 0.18s ease, transform 0.12s ease; 
      background:#fff; 
    }
    .day:hover { 
      background:#f7ecff; 
      transform: translateY(-4px);
    }
    .today { 
      background: linear-gradient(90deg,#ff66b2,#ffb6f2); 
      color:white; 
      font-weight:800; 
    }

    .upcoming-container { 
      background:#fff; 
      padding:12px; 
      border-radius:12px; 
      box-shadow:0 6px 18px rgba(0,0,0,0.04);
    }

    #upcoming-tasks li { 
      padding:8px; 
      border-radius:8px; 
      background:#fbfbff; 
      margin-bottom:8px; 
      font-weight:700; 
    }

    #tasks li { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; padding:8px 12px; 
      background:#fff; margin-bottom:8px; 
      border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.03);
    }

    .task-actions button { 
      border:none; 
      background:transparent; 
      cursor:pointer; 
      font-size:14px;
      margin-left:8px;
    }

    .task-input-box { 
      display:flex;
      gap:10px; 
      margin-top:10px; 
      background:#fff; 
      padding:10px; 
      border-radius:10px; 
      box-shadow:0 6px 18px rgba(0,0,0,0.04); 
    }

    .task-input-box input { 
      flex:1; 
      border:none; 
      outline:none; 
      font-size:14px; 
    }

    .task-input-box button { 
      background: linear-gradient(90deg,#6a0dad,#ff66b2); 
      color:white; 
      border:none; 
      padding:8px 14px; 
      border-radius:8px; 
      cursor:pointer; 
      font-weight:700;
    }

    .small-muted { 
      font-size:0.85rem; 
      color:#666; 
    }


    .hidden { 
      display: none !important; 
    }

    @media (max-width: 1024px) {
  .cards {
    grid-template-columns: 1fr; /* Stack cards on tablets */
  }

  .calendar-header {
    flex-direction: column;
    gap: 8px;
    text-align: center;
  }

  .calendar-grid {
    grid-template-columns: repeat(7, 1fr);
    font-size: 0.9rem;
  }

  .collab-table th, 
  .collab-table td {
    font-size: 0.9rem;
    padding: 8px;
  }
}

@media (max-width: 768px) {
  body {
    flex-direction: column;
  }

  .sidebar {
    width: 100%;
    flex-direction: row;
    justify-content: space-around;
    padding: 10px;
    border-right: none;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .sidebar h2 {
    display: none;
  }

  .sidebar a {
    font-size: 14px;
    padding: 10px;
    gap: 6px;
    flex: 1;
    justify-content: center;
  }

  .main {
    border-radius: 0;
    padding: 16px;
  }

  .header {
    flex-direction: column;
    gap: 10px;
    text-align: center;
  }

  .header input {
    width: 100%;
    max-width: 320px;
  }

  .collab-table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }

  .calendar-grid {
    grid-template-columns: repeat(7, minmax(30px, 1fr));
    gap: 4px;
  }

  .task-input-box {
    flex-direction: column;
    gap: 8px;
  }

  .task-input-box input, 
  .task-input-box button {
    width: 100%;
  }

  #dashboard-upcoming {
    font-size: 0.95rem;
    padding: 10px;
  }

  #dashboard-upcoming h4 {
    font-size: 1rem;
  }
}

  @media (max-width: 480px) {
    .sidebar a {
      font-size: 12px;
      padding: 8px;
    }
  
    .cards {
      gap: 12px;
    }
  
    .card h3 {
      font-size: 15px;
    }
  
    #dashboard-upcoming h4 {
      font-size: 0.95rem;
      padding: 6px 10px;
    }
  
    .calendar-header h3 {
      font-size: 1rem;
    }
  
    .day {
      font-size: 0.8rem;
      padding: 6px;
    }
  
    .task-input-box input {
      font-size: 0.9rem;
    }
  }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2>WORKSPHERE</h2>
    <a href="#" class="active" onclick="showTab(event, 'dashboard')"><i class="fas fa-home"></i> Dashboard</a>
    <a href="#" onclick="showTab(event, 'collaboration')"><i class="fas fa-comments"></i> Collaboration</a>
    <a href="#" onclick="showTab(event, 'calendar')"><i class="fas fa-calendar-alt"></i> Calendar</a>
  </div>

  <div class="main">
    <div class="header">
      <div class="title-left">
        <h1 id="page-title">Dashboard</h1>
      </div>

      <div style="display:flex;align-items:center;gap:12px;">
        <input type="text" placeholder="Search..." id="global-search">
        <div class="user-badge"><div class="user-initial">U</div><div><div style="font-weight:800;">USER</div><div class="small-muted">Online</div></div></div>
      </div>
    </div>

  
    <div id="dashboard" class="tab">
      <div class="cards">
        <div class="card">
          <h3><i class="fas fa-thumbtack"></i> Bulletin Board</h3>
          <div id="bulletin-board">
            <p>ðŸ“Œ Team Meeting every Monday at 10 AM</p>
            <p>ðŸ“Œ Submit project updates by Friday</p>
          </div>
        </div>
        <div class="card">
          <h3><i class="fas fa-bell"></i> Live Activity Feed</h3>
          <div id="activity-feed"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3><i class="fas fa-list"></i> Upcoming Tasks</h3>
        <div id="dashboard-upcoming" class="upcoming-container"></div>
      </div>
    </div>

    <div id="collaboration" class="tab hidden">
      <h2 style="color:#6a0dad; margin-bottom:10px;"><i class="fas fa-comments"></i> Collaboration Tracker</h2>
      <div style="margin-bottom:12px; display:flex; justify-content:flex-end;"><small class="small-muted">You are signed in as <strong>USER</strong></small></div>
      <table class="collab-table">
        <thead>
          <tr><th>Task</th><th>When (date)</th><th>Participants</th><th>Time Spent (mins)</th><th>Action</th></tr>
        </thead>
        <tbody id="collab-body"></tbody>
      </table>
    </div>


    <div id="calendar" class="tab hidden">
      <h2 style="color:#6a0dad;"><i class="fas fa-calendar-alt"></i> Calendar</h2>
      <div class="calendar-header">
        <button onclick="prevMonth()"><i class="fas fa-chevron-left"></i> Prev</button>
        <h3 id="month-year"></h3>
        <button onclick="nextMonth()">Next <i class="fas fa-chevron-right"></i></button>
      </div>
      <div class="calendar-grid" id="calendar-grid"></div>

      <div style="display:grid; grid-template-columns:1fr 380px; gap:16px; align-items:start;">
        <div class="upcoming-container">
          <h3 style="color:#6a0dad; margin-bottom:8px;">ðŸ“… Upcoming Tasks</h3>
          <ul id="upcoming-tasks"></ul>
        </div>
        <div class="card">
          <h4>Tasks for <span id="selected-date">Select a day</span></h4>
          <ul id="tasks"></ul>
          <div class="task-input-box">
            <input type="text" id="task-input" placeholder="Add a task">
            <button onclick="addTask()">Add</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const currentUser = 'USER';
    const demoMembers = ['Anna','James'];
    const joinTimes = JSON.parse(localStorage.getItem('joinTimes') || '{}');
    const timeSpent = JSON.parse(localStorage.getItem('timeSpent') || '{}'); 
    let tasks = JSON.parse(localStorage.getItem('tasks')) || {}; 
    let currentDate = new Date();

    function saveState(){ localStorage.setItem('tasks', JSON.stringify(tasks)); localStorage.setItem('joinTimes', JSON.stringify(joinTimes)); localStorage.setItem('timeSpent', JSON.stringify(timeSpent)); }

    function showTab(event, tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.add('hidden'));
      document.getElementById(tabId).classList.remove('hidden');
      document.getElementById("page-title").innerText = tabId.charAt(0).toUpperCase() + tabId.slice(1);
      document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
      event.currentTarget.classList.add('active');
      if (tabId === 'calendar') { renderCalendar(); renderUpcomingTasks(); }
      if (tabId === 'collaboration') renderCollaborationTable();
      if (tabId === 'dashboard') renderUpcomingOnDashboard();
    }

    function addActivity(message){
      const feed = document.getElementById('activity-feed');
      const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const div = document.createElement('div');
      div.classList.add('feed-item');
      div.innerHTML = `<strong>${message}</strong><div class="feed-time">${time}</div>`;
      feed.prepend(div);
    }


    function getAllTaskEntries(){
      const entries = [];
      for(const dateKey in tasks){
        tasks[dateKey].forEach((task, idx) => entries.push({ date: dateKey, task, id: `${dateKey}||${idx}` }));
      }
      entries.sort((a,b) => new Date(a.date) - new Date(b.date));
      return entries;
    }

    function renderCollaborationTable(){
      const tbody = document.getElementById('collab-body');
      tbody.innerHTML = '';
      const entries = getAllTaskEntries();
      if(entries.length === 0){ tbody.innerHTML = '<tr><td colspan="5" style="padding:18px; text-align:center; color:#777">No tasks available. Add tasks in Calendar.</td></tr>'; return; }
      entries.forEach(entry => {
        const tr = document.createElement('tr');
        const participants = (joinTimes[entry.id]) ? Object.keys(joinTimes[entry.id]) : [];
        const times = timeSpent[entry.id] || {};
        const totalMinutes = Object.values(times).reduce((a,b)=>a+ (parseInt(b)||0),0);
        tr.innerHTML = `
          <td><div class="task-title">${escapeHtml(entry.task)}</div><div class="small-muted">${entry.id.split('||')[0]}</div></td>
          <td>${entry.date}</td>
          <td><div class="profile-stack" id="p-${entry.id}"></div></td>
          <td id="time-${entry.id}">${totalMinutes} mins</td>
          <td id="actions-${entry.id}"></td>
        `;
        tbody.appendChild(tr);

        const stack = document.getElementById(`p-${entry.id}`);
        const joined = timeSpent[entry.id] ? Object.keys(timeSpent[entry.id]) : [];
        const showOrder = [currentUser, ...demoMembers.filter(m=>m!==currentUser)];
        showOrder.forEach(member => {
          if(joinTimes[entry.id] && joinTimes[entry.id][member]){
            const el = document.createElement('div'); el.className='profile-circle'; el.textContent = member.charAt(0);
            el.title = `${member} (joined)`;
            stack.appendChild(el);
          }
        });

        const actionsCell = document.getElementById(`actions-${entry.id}`);
  
        const joinBtn = document.createElement('button');
        joinBtn.className = 'btn-join small';
        if(joinTimes[entry.id] && joinTimes[entry.id][currentUser]){ joinBtn.textContent = 'Leave'; } else { joinBtn.textContent = 'Join'; }
        joinBtn.onclick = () => toggleJoin(entry.id, currentUser);
        actionsCell.appendChild(joinBtn);

        demoMembers.forEach(m=>{
          if(m === currentUser) return;
          const btn = document.createElement('button'); btn.className='btn-ghost small'; btn.style.marginLeft='8px'; btn.textContent = (joinTimes[entry.id] && joinTimes[entry.id][m]) ? `Leave ${m}` : `Join ${m}`;
          btn.onclick = ()=> toggleJoin(entry.id, m);
          actionsCell.appendChild(btn);
        });

  
        const doneBtn = document.createElement('button'); doneBtn.className='btn-done small'; doneBtn.style.marginLeft='8px'; doneBtn.textContent='Mark Done';
        doneBtn.onclick = ()=> markTaskDone(entry.id);
        actionsCell.appendChild(doneBtn);
      });
    }

    function toggleJoin(taskId, member){
      if(!joinTimes[taskId]) joinTimes[taskId] = {};
      if(!timeSpent[taskId]) timeSpent[taskId] = {};

      if(joinTimes[taskId][member]){
        const start = new Date(joinTimes[taskId][member]);
        const mins = Math.max(1, Math.round((new Date() - start)/60000));
        timeSpent[taskId][member] = (parseInt(timeSpent[taskId][member]) || 0) + mins;
        delete joinTimes[taskId][member];
        addActivity(`${member} left "${getTaskTitle(taskId)}" (+${mins} mins)`);
      } else {
        joinTimes[taskId][member] = new Date().toISOString();
        addActivity(`${member} joined "${getTaskTitle(taskId)}"`);
      }
      if(Object.keys(joinTimes[taskId]||{}).length === 0) delete joinTimes[taskId];
      if(Object.keys(timeSpent[taskId]||{}).length === 0) delete timeSpent[taskId];
      saveState(); renderCollaborationTable(); renderUpcomingTasks(); renderUpcomingOnDashboard();
    }

    function getTaskTitle(taskId){ const [date, idx] = taskId.split('||'); const arr = tasks[date] || []; return arr[parseInt(idx)] || '(task)'; }

    function markTaskDone(taskId){
      const [date, idx] = taskId.split('||');
      if(!tasks[date]) return;
      const removed = tasks[date].splice(parseInt(idx),1)[0];
      if(tasks[date].length === 0) delete tasks[date];
      if(joinTimes[taskId]){
        for(const m in joinTimes[taskId]){
          const start = new Date(joinTimes[taskId][m]);
          const mins = Math.max(1, Math.round((new Date() - start)/60000));
          timeSpent[taskId][m] = (parseInt(timeSpent[taskId][m])||0) + mins;
        }
        delete joinTimes[taskId];
      }
      addActivity(`Task done: "${removed}"`);
      saveState(); renderCollaborationTable(); renderUpcomingTasks(); renderUpcomingOnDashboard();
    }


    function renderCalendar(){
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month+1, 0);
      document.getElementById('month-year').textContent = currentDate.toLocaleString('default',{month:'long', year:'numeric'});
      const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
      const labels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      labels.forEach(l=>{ const el = document.createElement('div'); el.style.fontWeight='700'; el.style.color='#6b4a7a'; el.style.padding='6px 0'; el.style.textAlign='center'; el.textContent = l; grid.appendChild(el); });
      for(let i=0;i<firstDay.getDay();i++) grid.appendChild(document.createElement('div'));
      for(let d=1; d<= lastDay.getDate(); d++){
        const dayDiv = document.createElement('div'); dayDiv.className='day'; dayDiv.textContent = d;
        if(d === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) dayDiv.classList.add('today');
        dayDiv.onclick = ()=> selectDate(d,month,year);
        grid.appendChild(dayDiv);
      }
    }

    function selectDate(day, month, year){
      const dateKey = `${year}-${month+1}-${day}`;
      document.getElementById('selected-date').textContent = dateKey;
      displayTasks(dateKey);
    }

    function addTask(){
      const dateKey = document.getElementById('selected-date').textContent;
      if(dateKey === 'Select a day') return alert('Please select a day first!');
      const taskInput = document.getElementById('task-input');
      if(!taskInput.value.trim()) return;
      if(!tasks[dateKey]) tasks[dateKey] = [];
      tasks[dateKey].push(taskInput.value.trim());
      taskInput.value = '';
      saveState(); displayTasks(dateKey); renderUpcomingTasks(); renderCollaborationTable(); renderUpcomingOnDashboard(); addActivity(`Task added: "${tasks[dateKey][tasks[dateKey].length-1]}" on ${dateKey}`);
    }

    function displayTasks(dateKey){
      const taskList = document.getElementById('tasks'); taskList.innerHTML = '';
      (tasks[dateKey] || []).forEach((task, i)=>{
        const li = document.createElement('li');
        const id = `${dateKey}||${i}`;
        li.innerHTML = `<div style='max-width:70%'>${escapeHtml(task)}</div><div style='display:flex;gap:8px;align-items:center'>
          <button class='btn-ghost' onclick="editTask('${dateKey}',${i})"><i class='fas fa-edit'></i></button>
          <button class='btn-ghost' onclick="deleteTask('${dateKey}',${i})"><i class='fas fa-trash'></i></button>
          <button class='btn-join small' onclick="toggleJoin('${id}','${currentUser}')">Join</button>
        </div>`;
        taskList.appendChild(li);
      });
    }

    function editTask(dateKey, index){
      const newTask = prompt('Edit task:', tasks[dateKey][index]);
      if(newTask !== null && newTask.trim()){
        tasks[dateKey][index] = newTask.trim(); saveState(); displayTasks(dateKey); renderUpcomingTasks(); renderCollaborationTable(); renderUpcomingOnDashboard();
      }
    }

    function deleteTask(dateKey,index){
      const removed = tasks[dateKey].splice(index,1)[0]; if(tasks[dateKey].length === 0) delete tasks[dateKey]; saveState(); displayTasks(dateKey); renderUpcomingTasks(); renderCollaborationTable(); renderUpcomingOnDashboard(); addActivity(`Task deleted: "${removed}"`);
    }
    function renderUpcomingTasks(){
      const today = new Date();
      const upcoming = [];
      for(const dateKey in tasks){
        const [y,m,d] = dateKey.split('-').map(Number);
        const dt = new Date(y,m-1,d);
        if(dt >= new Date(today.getFullYear(), today.getMonth(), today.getDate())){
          tasks[dateKey].forEach(t=> upcoming.push({date:dateKey, task:t}));
        }
      }
      upcoming.sort((a,b)=> new Date(a.date)- new Date(b.date));
      const ul = document.getElementById('upcoming-tasks'); ul.innerHTML='';
      upcoming.slice(0,6).forEach(item=>{ const li = document.createElement('li'); li.textContent = `${item.date}: ${item.task}`; ul.appendChild(li); });
    }

    function renderUpcomingOnDashboard(){
      const container = document.getElementById('dashboard-upcoming'); container.innerHTML='';
      const upcoming = [];
      for(const dateKey in tasks){ tasks[dateKey].forEach(t=> upcoming.push({date:dateKey,task:t})); }
      upcoming.sort((a,b)=> new Date(a.date)- new Date(b.date));
      if(upcoming.length === 0) container.textContent = 'No upcoming tasks.';
      else upcoming.slice(0,5).forEach(it=>{ const p = document.createElement('div'); p.style.marginBottom='8px'; p.textContent = `${it.date} â€” ${it.task}`; container.appendChild(p); });
    }


    function prevMonth(){ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); }
    function nextMonth(){ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); }

    function escapeHtml(unsafe) { return (''+unsafe).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]); }); }

   
    renderCalendar(); renderUpcomingTasks(); renderUpcomingOnDashboard(); renderCollaborationTable();

    setInterval(()=>{
      for(const taskId in joinTimes){
        for(const m in joinTimes[taskId]){
          const start = new Date(joinTimes[taskId][m]);
          const extra = Math.max(0, Math.round((new Date()-start)/60000));
          if(!timeSpent[taskId]) timeSpent[taskId] = {};
          const base = parseInt(JSON.parse(localStorage.getItem('timeSpent')||'{}')[taskId]?.[m] || 0);
          const total = base + extra;
          const cell = document.getElementById('time-'+taskId);
          if(cell){
            const t = Object.keys(timeSpent[taskId]||{}).reduce((s,k)=> s + (parseInt(timeSpent[taskId][k])||0), 0) + extra;
            cell.textContent = `${t} mins`;
          }
        }
      }
    }, 5000);

  </script>
</body>
</html>

